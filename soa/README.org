* internal
#+name: src-dir
#+begin_src elisp
  (progn
    (mkdir "build-gcc" t)
    (mkdir "build-gcc-debug" t)
    (mkdir "build-gcc-debug-siconos" t)
    (mkdir "build-clang" t)
    (mkdir "build-clang-debug" t)
    (mkdir "build-clang-debug-siconos" t)
    (mkdir "build-local-clang-debug" t)
    default-directory)
#+end_src


#+RESULTS:

* gcc

** Release

#+name: mybenchmarks-cmake-gcc
#+header: :var src_dir=src-dir
#+header: :dir build-gcc
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark gcc-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DSICONOS_INSTALL_DIR=\${GUIX_ENVIRONMENT} -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=1" 
#+end_src

#+name: mybenchmarks-make-gcc
#+header: :var src_dir=src-dir
#+header: :dir build-gcc
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark gcc-toolchain boost fmt range-v3 cmake make -- \
       make VERBOSE=1
#+end_src


** Debug

#+name: mybenchmarks-cmake-gcc-debug
#+header: :var src_dir=src-dir
#+header: :dir build-gcc-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark gcc-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DSICONOS_INSTALL_DIR=\${GUIX_ENVIRONMENT} -DCMAKE_BUILD_TYPE=Debug" 
#+end_src

#+name: mybenchmarks-make-gcc-debug
#+header: :var src_dir=src-dir
#+header: :dir build-gcc-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark gcc-toolchain boost fmt range-v3 cmake make dash -- \
       make VERBOSE=1
#+end_src

*** debug siconos

#+name: mybenchmarks-cmake-gcc-debug-siconos
#+header: :var src_dir=src-dir
#+header: :dir build-gcc-debug-siconos
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc eigen benchmark suitesparse gcc-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DGUIX_ENVIRONMENT=\${GUIX_ENVIRONMENT} -DCMAKE_CXX_STANDARD_LIBRARIES=-L/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos/lib64 -DSICONOS_INSTALL_DIR=/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos -DCMAKE_BUILD_TYPE=Debug" 
#+end_src

#+name: mybenchmarks-make-gcc-debug-siconos
#+header: :var src_dir=src-dir
#+header: :dir build-gcc-debug-siconos
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc eigen benchmark suitesparse gcc-toolchain boost fmt range-v3 cmake make dash -- \
       make VERBOSE=1 && LD_LIBRARY_PATH=/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos/lib64 ./src/siconos/tests/tnonos
#+end_src





* clang

** Release

#+name: mybenchmarks-cmake-clang
#+header: :var src_dir=src-dir
#+header: :dir build-clang
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark clang-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DSICONOS_INSTALL_DIR=\${GUIX_ENVIRONMENT} -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=1" 
#+end_src

#+name: mybenchmarks-make-clang
#+header: :var src_dir=src-dir
#+header: :dir build-clang
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark clang-toolchain boost fmt range-v3 cmake make -- \
       make VERBOSE=1
#+end_src


** Debug

#+name: mybenchmarks-cmake-clang-debug
#+header: :var src_dir=src-dir
#+header: :dir build-clang-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark clang-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DSICONOS_INSTALL_DIR=\${GUIX_ENVIRONMENT} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=1" 
#+end_src

#+name: mybenchmarks-make-clang-debug
#+header: :var src_dir=src-dir
#+header: :dir build-clang-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc siconos benchmark clang-toolchain boost fmt range-v3 cmake make -- \
       make VERBOSE=1
#+end_src

** DebugSiconos

#+name: mybenchmarks-cmake-clang-debug-siconos
#+header: :var src_dir=src-dir
#+header: :dir build-clang-debug-siconos
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc eigen suitesparse benchmark clang-toolchain boost fmt range-v3 cmake make dash -- \
       dash -c "cmake ${src_dir} -DGUIX_ENVIRONMENT=\${GUIX_ENVIRONMENT} -DCMAKE_CXX_STANDARD_LIBRARIES=-L/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos/lib64 -DSICONOS_INSTALL_DIR=/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos -DCMAKE_BUILD_TYPE=Debug" 
#+end_src

#+name: mybenchmarks-make-clang-debug-siconos
#+header: :var src_dir=src-dir
#+header: :dir build-clang-debug-siconos
#+begin_src sh :compile :results output silent
guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --pure --ad-hoc eigen suitesparse benchmark clang-toolchain boost fmt range-v3 cmake make dash -- \
       make VERBOSE=1
#+end_src

#+name: mybenchmarks-make-clang-debug-siconos-run-bouncing-ball
#+header: :var src_dir=src-dir
#+header: :dir (concat "build-clang-debug-siconos" "/src/siconos/tests")
#+begin_src sh :compile :results output silent
  LD_LIBRARY_PATH=/scratch/maurice/install/maurice/siconos/mymaster/Debug/siconos/lib64 ./bouncing_ball
#+end_src

#+name: mybenchmarks-make-clang-debug-siconos-run-bouncing-ball
#+header: :var src_dir=src-dir
#+header: :dir (concat "build-clang-debug-siconos" "/src/siconos/tests")
#+begin_src gnuplot :file "./results.png"
  #set  term X11
#!tail -n 100000 result.dat > result-gp.dat
resultfile = "result.dat"
#resultfile = "BouncingBallSchatzmanPaoliOSI.ref"
#resultfile = "result_tdg.dat"
plot \
resultfile every ::2 u 1:2 t "Ball position" w l,\
resultfile every ::2 u 1:3 t "Ball Velocity" w l,\
resultfile every ::2 u 1:4 t "Reaction force" w l

#,\
#"result-gp.dat" u 1:5 t "Multiplier" w l
#+end_src

#+RESULTS: mybenchmarks-make-clang-debug-siconos-run-bouncing-ball
[[file:build-clang-debug-siconos/src/siconos/tests/results.png]]


** DebugLocal

#+name: mybenchmarks-cmake-local-clang-debug
#+header: :var src_dir=src-dir
#+header: :dir build-local-clang-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
     environment --ad-hoc siconos benchmark dash -- \
     dash -c "CC=/usr/local/bin/clang cmake ${src_dir} -DSICONOS_INSTALL_DIR=\${GUIX_ENVIRONMENT} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=1"
#+end_src

#+name: mybenchmarks-make-local-clang-debug
#+header: :var src_dir=src-dir
#+header: :dir build-local-clang-debug
#+begin_src sh :compile :results output silent
  guix time-machine -C ${src_dir}/siconos-2023-03-06.scm -- \
       environment --ad-hoc siconos benchmark dash -- \
    dash -c "make -k VERBOSE=1 "
#+end_src

* Run

#+name: mybenchmarks-gcc
#+header: :dir build-gcc
#+begin_src sh :compile :results output silent
  sudo cpupower frequency-set --governor performance
  ./tgraph
  sudo cpupower frequency-set --governor powersave
#+end_src


#+name: mybenchmarks-gcc-debug
#+header: :dir build-gcc-debug
#+begin_src sh :compile :results output silent
  ./tgraph
#+end_src



#+name: tshapes
#+begin_src sh :compile :results output silent
  sudo cpupower frequency-set --governor performance
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-06-08.scm && \
    guix time-machine -C siconos-2021-06-08.scm -- \
         environment --pure --ad-hoc benchmark gcc-toolchain boost cmake make \
         coreutils grep dash \
         siconos -- siconos -lbenchmark tshapes.cpp
  sudo cpupower frequency-set --governor powersave
#+end_src


#+name: tgraph
#+begin_src sh :compile :results output silent
  sudo cpupower frequency-set --governor performance
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-06-08.scm && \
    guix time-machine -C siconos-2021-06-08.scm -- \
         environment --pure --ad-hoc benchmark gcc-toolchain boost cmake make \
         coreutils grep dash \
         siconos -- siconos -lbenchmark --compiler-options=-fconcepts-ts tgraph.cpp
  sudo cpupower frequency-set --governor powersave
#+end_src

#+name: tgg
#+begin_src sh :compile :results output silent
#  sudo cpupower frequency-set --governor performance
  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-06-08.scm && \
    guix time-machine -C siconos-2021-06-08.scm -- \
         environment --pure --ad-hoc benchmark boost gcc-toolchain boost cmake make \
         coreutils grep dash \
         siconos -- siconos -lboost_chrono tgg.cpp
#  sudo cpupower frequency-set --governor powersave
#+end_src


#+name: t
#+begin_src sh :compile :results output silent
#  sudo cpupower frequency-set --governor performance
#  wget -N https://raw.githubusercontent.com/siconos/guix-siconos/channels/siconos-2021-06-08.scm && \
    guix time-machine -C siconos-2021-06-08.scm -- \
         environment --pure --ad-hoc benchmark boost gcc-toolchain boost cmake make \
         coreutils grep dash \
         siconos -- siconos -lboost_chrono t.cpp
#  sudo cpupower frequency-set --governor powersave
#+end_src
